!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.CanvasVideo=e()}}(function(){var e,t,n;return function i(e,t,n){function r(u,a){if(!t[u]){if(!e[u]){var s=typeof require=="function"&&require;if(!a&&s)return s(u,!0);if(o)return o(u,!0);var f=new Error("Cannot find module '"+u+"'");throw f.code="MODULE_NOT_FOUND",f}var c=t[u]={exports:{}};e[u][0].call(c.exports,function(t){var n=e[u][1][t];return r(n?n:t)},c,c.exports,i,e,t,n)}return t[u].exports}var o=typeof require=="function"&&require;for(var u=0;u<n.length;u++)r(n[u]);return r}({1:[function(e,t,n){"use strict";var i={uid:function(){var e=(new Date).getTime();var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+Math.random()*16)%16|0;e=Math.floor(e/16);return(t=="x"?n:n&3|8).toString(16)});return t},removeVideoElement:function(e){var t;if(e===null){return false}t=e.querySelectorAll("source");for(var n=t.length-1;n>=0;n--){e.removeChild(t[n])}e.src="";e.removeAttribute("src");if(e.load instanceof Function){e.load()}if(e.parentNode instanceof HTMLElement){e.parentNode.removeChild(e)}return e},getExtension:function(e){var t=/[.]/.exec(e)?/[^.]+$/.exec(e)[0]:undefined;if(t)t=t.substring(0,3);return t},getAudioSupport:function(e){var t=new Audio;if(!e){var n={mp3:!!t.canPlayType("audio/mpeg;").replace(/^no$/,""),opus:!!t.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!t.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!t.canPlayType("audio/aac;").replace(/^no$/,""),m4a:!!(t.canPlayType("audio/x-m4a;")||t.canPlayType("audio/m4a;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(t.canPlayType("audio/x-mp4;")||t.canPlayType("audio/mp4;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")};return n}else{return!!t.canPlayType(e).replace(/^no$/,"")}},isIOSdevice:/iPhone|iPad|iPod/i.test(navigator.userAgent)?true:false,getCurrentTimeRange:function(e,t){var n=e.buffered.length-1;var i=false;var r=t!=undefined?t:e.currentTime;while(n>=0){if(r>=e.buffered.start(n)&&r<=e.buffered.end(n)){i=n;n=-1}n--}return i},capBufferTime:function(e,t){if(e.currentTime+t>e.duration)return e.duration-e.currentTime;else return t}};t.exports=i},{}],2:[function(e,t,n){"use strict";var i={ENDED:"ended",LOAD_START:"loadstart",CAN_PLAY:"canplay",CAN_PLAY_THROUGH:"canplaythrough",PLAYING:"playing",PLAY:"play",PAUSE:"pause",PROGRESS:"progress",READY:"ready",TIME_UPDATE:"timeupdate",WAITING:"waiting",SEEKING:"seeking",SEEKED:"seeked",COMPLETE:"complete"};t.exports=i},{}],3:[function(e,t,n){"use strict";function i(e,t){this.type=e;if(t===undefined)t={};this.datas=t;this.timeStamp=Number(new Date)}i.prototype.constructor=i;t.exports=i},{}],4:[function(e,t,n){"use strict";var i=function(){};i.prototype={constructor:i,apply:function(e){e.addEventListener=i.prototype.addEventListener;e.hasEventListener=i.prototype.hasEventListener;e.removeEventListener=i.prototype.removeEventListener;e.dispatchEvent=i.prototype.dispatchEvent},addEventListener:function(e,t){if(this._listeners===undefined)this._listeners={};var n=this._listeners;if(n[e]===undefined){n[e]=[]}if(n[e].indexOf(t)===-1){n[e].push(t)}},hasEventListener:function(e,t){if(this._listeners===undefined)return false;var n=this._listeners;if(n[e]!==undefined&&n[e].indexOf(t)!==-1){return true}return false},removeEventListener:function(e,t){if(this._listeners===undefined)return;var n=this._listeners;var i=n[e];if(i!==undefined){var r=i.indexOf(t);if(r!==-1){i.splice(r,1)}}},dispatchEvent:function(e){if(this._listeners===undefined)return;var t=this._listeners;var n=t[e.type];if(n!==undefined){e.target=this;var i=[];var r=n.length;for(var o=0;o<r;o++){i[o]=n[o]}for(var o=0;o<r;o++){i[o].call(this,e)}}},bubble:function(e){this.dispatchEvent(e)}};t.exports=i},{}],5:[function(e,t,n){"use strict";var i=e("../event/EventDispatcher"),r=e("../event/Event"),o=e("../event/CanvasVideoEvent"),u=e("../core/Utils");function a(e,t){i.call(this);var n=this;var a,s,f;var c=0;var p={_startTimestamp:0,_playbackTime:0,isPlaying:false};this.options={loop:false};var d=false,l=false,v=false;this._useWebAudio=!t;function m(e){if(n._useWebAudio)y(e);else h();if(u.isIOSdevice){d=true;if(n._useWebAudio)x()}}this.set=function(e,t){for(var i in t){n.options[i]=t[i]}b(e)};this.play=function(){if(n._useWebAudio){if(d){if(!l){v=true}else{if(p.buffer)T()}}else{if(p.buffer)T()}}else{if(p.source)T()}};this.pause=function(){A()};this.needBuffering=function(e,t){if(!n._useWebAudio){var i=u.getCurrentTimeRange(p.source);return p.source.buffered.end(i)-p.source.currentTime<u.capBufferTime(p.source,t)||u.getCurrentTimeRange(p.source,e)===false}else{return c>=1?false:true}};this.destroy=function(){P();if(n._useWebAudio){p.source.disconnect(0);s.disconnect(0);s=null}p=null};function y(e){if(e!=null){a=e}else if(typeof AudioContext!=="undefined"){a=new AudioContext}else if(typeof webkitAudioContext!=="undefined"){a=new webkitAudioContext}else{h();return}s=typeof a.createGain==="undefined"?a.createGainNode():a.createGain();s.connect(a.destination)}function h(){n._useWebAudio=false;p.source=new Audio}function b(e){if(n._useWebAudio){s.gain.value=n.options.volume;if(n.options.arraybuffer!=null){c=1;g(n.options.arraybuffer)}else{f=new XMLHttpRequest;f.open("get",e,true);f.responseType="arraybuffer";f.onload=function(){g(f.response)};f.onprogress=function(e){if(e.lengthComputable){c=e.loaded/e.total;n.dispatchEvent(new r(o.PROGRESS))}};f.send()}}else{p.source.src=e;p.source.volume=n.options.volume;p.source.addEventListener("canplaythrough",O);p.source.addEventListener("ended",_);p.source.addEventListener("progress",L);p.source.load()}}function g(e){a.decodeAudioData(e,function(e){p.buffer=e;O()})}function E(){p.source=a.createBufferSource();p.source.buffer=p.buffer;p.source.playbackRate.value=n.options.rate;p.source.connect(s);p.source.onended=_}function T(){if(n._useWebAudio){if(!p.isPlaying){E();p.source.start(0,p._playbackTime);p._startTimestamp=Date.now();p.isPlaying=true}}else{p.source.play()}}function P(e){if(n._useWebAudio){if(p.isPlaying){p.source.onended=null;p.source.stop(0);p._playbackTime=e?n.options.rate*(Date.now()-p._startTimestamp)/1e3+p._playbackTime:0;p.isPlaying=false}}else{p.source.pause();if(!e)p.source.currentTime=0}}function A(){P(true)}function w(e){if(p.isPlaying){P();p._playbackTime=e;T()}else{p._playbackTime=e}}function x(){var e=function(){var t=a.createBuffer(1,1,22050);var i=a.createBufferSource();i.buffer=t;i.connect(a.destination);if(typeof i.start==="undefined"){i.noteOn(0)}else{i.start(0)}setTimeout(function(){window.removeEventListener("touchend",e,false);l=true;if(v)n.play()},0)};window.addEventListener("touchend",e,false)}function O(e){n.dispatchEvent(new r(o.CAN_PLAY,{}))}function _(e){n.dispatchEvent(new r(o.ENDED,{}));if(n.options.loop){P();T()}}function L(e){n.dispatchEvent(new r(o.PROGRESS))}Object.defineProperty(n,"loop",{get:function(){return n.options.loop},set:function(e){n.options.loop=e}});Object.defineProperty(n,"currentTime",{get:function(){if(n._useWebAudio){if(p.isPlaying){return p.source?n.options.rate*(Date.now()-p._startTimestamp)/1e3+p._playbackTime:0}else{return p._playbackTime}}else{return p.source.currentTime}},set:function(e){if(n._useWebAudio)w(e);else p.source.currentTime=e}});Object.defineProperty(n,"volume",{get:function(){if(n._useWebAudio)return p.source?s.gain.value:1;else return p.source?p.source.volume:1},set:function(e){n.options.volume=e;if(n._useWebAudio)s.gain.value=e;else p.source.volume=e}});Object.defineProperty(n,"playbackRate",{get:function(){return n.options.rate},set:function(e){if(n._useWebAudio){A();n.options.rate=e;T()}else{n.options.rate=e;p.source.playbackRate=e}}});Object.defineProperty(n,"bufferLength",{get:function(){if(!n._useWebAudio){var e=u.getCurrentTimeRange(p.source);var t=p.source.buffered.length===0?0:p.source.buffered.end(e)-p.source.currentTime;return t>=0?t:0}else{return c*n.options.bufferTime}}});Object.defineProperty(n,"iOSEnabled",{get:function(){if(!n._useWebAudio){return true}else{return!l}}});m(e)}a.prototype=Object.create(i.prototype);a.prototype.constructor=a;t.exports=a},{"../core/Utils":1,"../event/CanvasVideoEvent":2,"../event/Event":3,"../event/EventDispatcher":4}],6:[function(e,t,n){"use strict";var i=e("../event/EventDispatcher"),r=e("../event/Event"),o=e("../core/Utils"),u=e("./AudioPlayer"),a=e("../event/CanvasVideoEvent");function s(e,t){i.call(this);var n=this;var s,f,c,p;var d,l=0,v=0;var m=false,y,h=false,b=false,g=false,E=false,T=false,P=false,A=true;var w=1;n.options={fps:24,loop:false,xhr:true,autoplay:false,volume:1,playbackRate:1,audioBuffer:false,bufferTime:4};function x(e,t){y=o.isIOSdevice;Y(e);for(var i in t){n.options[i]=t[i]}if(n.options.audio){p=new u(n.options.audioContext,n.options.audioBuffer);if(!t.fps)n.options.fps=33}if(n.options.bufferTime<w)n.options.bufferTime=w;if(t.canvas)s=t.canvas;else s=document.createElement("canvas");f=s.getContext("2d");if(n.options.width)s.width=n.options.width;if(n.options.height)s.height=n.options.height;if(n.options.preload===true||n.options.autoplay===true)n.load()}this.load=function(){if(!m){if(n.options.xhr){S(e)}else{C(e)}n.dispatchEvent(new r(a.LOAD_START))}};this.play=function(){O(false)};this.pause=function(){_(false)};this.destroy=function(){T=false;if(p){p.removeEventListener(a.CAN_PLAY,B);p.removeEventListener(a.ENDED,q);p.removeEventListener(a.PROGRESS,$);p.destroy();p=null}A=true;o.removeVideoElement(c);W(false);f.clearRect(0,0,c.width,c.height);c=null};this.canPlayType=function(e){var t;if(c)t=c;else t=document.createElement("video");return t.canPlayType(e)};function O(e){if(m&&g){d=Date.now();if(D(true)){T=true;P=false;if(p){d=p.currentTime;p.play()}n.dispatchEvent(new r(a.PLAY))}else{T=true;P=true;if(!A){n.dispatchEvent(new r(a.WAITING))}}if(!e){R();L()}}else{n.options.autoplay=true;if(!m)this.load()}}function _(e){if(!e){T=false;P=false;n.dispatchEvent(new r(a.PAUSE))}if(p){p.pause()}}function L(){if(P)D();if(T&&!P){if(n.options.audio){var e=p.currentTime;var t=e-d}else{var e=Date.now();var t=(e-d)/1e3}if(t>=1e3/n.options.fps/1e3){if(!n.options.audio){if(c.buffered.length>0){var i=o.getCurrentTimeRange(c);var u=c.currentTime+t*n.options.playbackRate;if(c.buffered.end(i)-c.currentTime<o.capBufferTime(c,w)&&u<=c.duration){P=true;_(true);n.dispatchEvent(new r(a.WAITING))}else{c.currentTime=u;d=e}}}else{if(c.buffered.length>0){var i=o.getCurrentTimeRange(c);var u=c.currentTime+t;var s=c.buffered.end(i)-c.currentTime<o.capBufferTime(c,w);var f=p.needBuffering(u,w);if((s||f)&&u<=c.duration){P=true;_(true);n.dispatchEvent(new r(a.WAITING))}else{c.currentTime=u;d=c.currentTime}}}}l=Math.round(parseFloat(c.currentTime)*1e4)/1e4;var v=Math.round(parseFloat(c.duration)*1e4)/1e4;if(l>=v){if(!n.options.audio)n.dispatchEvent(new r(a.ENDED));if(n.options.loop){if(!n.options.audio){A=true;c.currentTime=0}}else{T=false;n.currentTime=0;return}}}requestAnimationFrame(L)}function R(){f.drawImage(c,0,0,c.width,c.height);n.dispatchEvent(new r(a.TIME_UPDATE));if(E){n.dispatchEvent(new r(a.CAN_PLAY));n.dispatchEvent(new r(a.SEEKED));E=false;O(true)}}function C(e){m=true;c=k(e);W(true);if(!n.options.id)s.id=o.uid();else s.id=n.options.id;setTimeout(function(){c.load()},50);if(n.options.audio){var t=null;var i;if(e.arraybuffer&&typeof n.options.audio!="string"){t=e.arraybuffer;i=U(true)}else{i=U(false)}p.set(i,{loop:n.options.loop,volume:n.options.volume,rate:n.options.playbackRate,arraybuffer:t,bufferTime:n.options.bufferTime});if(n.options.muted)n.muted=true;p.addEventListener(a.CAN_PLAY,B);p.addEventListener(a.ENDED,q);p.addEventListener(a.PROGRESS,$)}}function S(e){var t=I(e);var i=t.src;var o=t.mime;var u=new XMLHttpRequest;u.open("GET",i,true);u.responseType="arraybuffer";u.onload=function(e){var t=URL.createObjectURL(new Blob([e.target.response],{type:o}));C({src:t,mime:o,arraybuffer:u.response});n.dispatchEvent(new r(a.COMPLETE))};u.onprogress=function(e){if(e.lengthComputable){v=e.loaded/e.total;n.dispatchEvent(new r(a.PROGRESS))}};u.send()}function j(){g=true;R();n.dispatchEvent(new r(a.CAN_PLAY));if(n.options.autoplay)O()}function D(e){var t=o.capBufferTime(c,n.options.bufferTime);var i=o.getCurrentTimeRange(c);var u=n.options.audio?p.bufferLength>=t:true;if(c.buffered.length>0){if(c.buffered.end(i)-c.currentTime>=t&&u){if(P&&!e){n.dispatchEvent(new r(a.CAN_PLAY_THROUGH));n.dispatchEvent(new r(a.CAN_PLAY));if(T)n.dispatchEvent(new r(a.PLAYING));P=false;O(true)}return true}else{return false}}else{return false}}function N(){if(A){if(D(true)){A=false;n.dispatchEvent(new r(a.CAN_PLAY_THROUGH))}}}function W(e){var t=e===false?"removeEventListener":"addEventListener";c[t]("timeupdate",R);c[t]("canplay",M);c[t]("canplaythrough",M);c[t]("progress",H)}function k(e){var t;if(Array.isArray(e)){t=document.createElement("video");for(var n=0;n<e.length;++n){if(typeof e[n]==="string"){t.appendChild(G(e[n]))}else{var i=e[n].mime?e[n].mime:e[n].type;t.appendChild(G(e[n].src,i))}}}else if(typeof e==="string"){t=document.createElement("video");t.appendChild(G(e))}else if(typeof e==="object"&&e.nodeType!=1){t=document.createElement("video");var i=e.mime?e.mime:e.type;t.appendChild(G(e.src,i))}else{t=e}return t}function G(e,t){var n=document.createElement("source");n.src=e;var i=o.getExtension(e);if(i||t)n.type=t?t:"video/"+i;return n}function I(e){var t={};if(Array.isArray(e)){if(typeof e[0]==="string"){t.src=e[0]}else{var n=e[0].mime?e[0].mime:e[0].type;t.src=e[0].src;t.mime=n}}else if(typeof e==="string"){t.src=e}else if(typeof e==="object"){if(e.nodeType!=1){var n=e.mime?e.mime:e.type;t.src=e.src;t.mime=n}else{var i=e.querySelectorAll("source");if(i.length>0){var n=i[0].mime?i[0].mime:i[0].type;t.src=i[0].src;t.mime=n}else{var n=e.mime?e.mime:e.type;t.src=e.src;t.mime=n}}}else{t=e}t.mime=t.mime?t.mime:"video/"+o.getExtension(t.src);return t}function U(e){var t;if(typeof n.options.audio==="boolean"){var i=c.querySelectorAll("source");for(var r=0;r<=i.length-1;r++){if(o.getAudioSupport(i[r].type)||o.getAudioSupport("video/"+o.getExtension(i[r].src))||!i[r].type){t=i[r].src;if(!e)t=t+"?audio=";break}}}else if(typeof n.options.audio==="string"){t=n.options.audio}return t}function Y(e){if(e.nodeType===1){n.options.loop=e.loop;n.options.autoplay=e.autoplay;e.autoplay=false;if(e.preload==="auto")n.options.preload=true}}function B(e){if(!b){b=true;if(h)j()}}function M(e){if(!h){if(!n.options.width)s.width=c.videoWidth;if(!n.options.height)s.height=c.videoHeight;c.width=s.width;c.height=s.height;h=true;if(!n.options.audio){j()}else if(b){j()}}}function H(e){if(!n.xhr)n.dispatchEvent(new r(a.PROGRESS));N()}function q(e){n.dispatchEvent(new r(a.ENDED));if(n.options.loop){T=true;p.currentTime=0;c.currentTime=0;d=p.currentTime;n.currentTime=0}else{T=false;p.currentTime=0;c.currentTime=0;d=p.currentTime;p.pause()}}function $(e){n.dispatchEvent(new r(a.PROGRESS));N()}Object.defineProperty(n,"autoplay",{get:function(){return n.options.autoplay},set:function(e){n.options.autoplay=true}});Object.defineProperty(n,"bufferLength",{get:function(){var e;if(n.options.xhr){e=v*n.options.bufferTime}else{var t=o.getCurrentTimeRange(c);e=c.buffered.length===0?0:c.buffered.end(t)-c.currentTime;e=e>=0?e:0}if(n.options.audio&&p&&!(n.options.xhr&&n.options.audio!="string")){e=Math.min(e,p.bufferLength)}return e}});Object.defineProperty(n,"bufferTime",{get:function(){return c?o.capBufferTime(c,n.options.bufferTime):n.options.bufferTime},set:function(e){n.options.bufferTime=e>=w?e:w;if(p)p.options.bufferTime=n.options.bufferTime}});Object.defineProperty(n,"controls",{get:function(){console.warn("controls attribute is not currently supported by CanvasVideo.")},set:function(e){console.warn("controls attribute is not currently supported by CanvasVideo.")}});Object.defineProperty(n,"currentSrc",{get:function(){return c.currentSrc}});Object.defineProperty(n,"currentTime",{get:function(){return l},set:function(e){E=true;n.dispatchEvent(new r(a.SEEKING));if(p){T=true;p.currentTime=e;c.currentTime=e;d=p.currentTime;_(true)}else{c.currentTime=e}}});Object.defineProperty(n,"duration",{get:function(){if(c)return c.duration;else return NaN}});Object.defineProperty(n,"element",{get:function(){return s}});Object.defineProperty(n,"fps",{get:function(){return n.options.fps},set:function(e){if(n.options.audio)n.options.fps=e}});Object.defineProperty(n,"height",{get:function(){return s.height},set:function(e){n.options.height=e;if(s)s.height=e;if(c)c.height=e}});Object.defineProperty(n,"id",{get:function(){return s.id},set:function(e){s.id=e}});Object.defineProperty(n,"loop",{get:function(){return n.options.loop},set:function(e){if(p)p.loop=e;n.options.loop=e}});Object.defineProperty(n,"muted",{get:function(){if(!p||p.volume!=0)return false;else return true},set:function(e){if(e){if(p)p.volume=0}else{if(p)p.volume=n.options.volume}}});Object.defineProperty(n,"needTouchDevice",{get:function(){var e=false;if(y){if(n.options.audio&&p)e=p.iOSEnabled;else if(n.options.audio)e=true;else e=false}return e}});Object.defineProperty(n,"paused",{get:function(){return!T}});Object.defineProperty(n,"playbackRate",{get:function(){return n.options.playbackRate},set:function(e){n.options.playbackRate=e;if(n.options.audio&&p)p.playbackRate=e}});Object.defineProperty(n,"readyState",{get:function(){return g?4:0}});Object.defineProperty(n,"seeking",{get:function(){return E}});Object.defineProperty(n,"src",{get:function(){return e}});Object.defineProperty(n,"useWebAudioAPI",{get:function(){if(n.options.audio&&p)return p._useWebAudio;else return false}});Object.defineProperty(n,"videoHeight",{get:function(){return c.videoHeight}});Object.defineProperty(n,"videoWidth",{get:function(){return c.videoWidth}});Object.defineProperty(n,"volume",{get:function(){return n.options.volume},set:function(e){n.options.volume=e;if(p)p.volume=e}});Object.defineProperty(n,"width",{get:function(){return s.width},set:function(e){n.options.width=e;if(s)s.width=e;if(c)c.width=e}});Object.defineProperty(n,"xhr",{get:function(){return n.options.xhr}});x(e,t)}s.prototype=Object.create(i.prototype);s.prototype.constructor=s;t.exports=s},{"../core/Utils":1,"../event/CanvasVideoEvent":2,"../event/Event":3,"../event/EventDispatcher":4,"./AudioPlayer":5}]},{},[6])(6)});